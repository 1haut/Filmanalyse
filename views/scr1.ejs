<%- include('partials/header.ejs') %>
<%- include('partials/body.ejs', data) %>
<script>
      // Register ChartDataLabel plugin
      // Chart.register(ChartDataLabels);
      // Define font for charts
      Chart.defaults.font.family = "'Outfit', sans-serif";

      const colorWheel = [
        "#003a7d",
        "#008dff",
        "#ff73b6",
        "#c701ff",
        "#4ecb8d",
        "#ff9d3a",
        "#f9e858",
        "#d83034",
      ];
      const infoButtons = document.querySelectorAll(".popover-btn");
      const infoBoxes = document.querySelectorAll(".popover-text");

      for (let i = 0; i < infoButtons.length; i++) {
        infoButtons[i].addEventListener("mouseenter", () => {
          infoBoxes[i].style.display = "block";
        });

        infoButtons[i].addEventListener("mouseleave", () => {
          infoBoxes[i].style.display = "none";
        });
      }

      const charts = document.querySelectorAll(".chart");

      const canvas1 = document.getElementById("chart1");
      const canvas2 = document.getElementById("chart2");
      const canvas3 = document.getElementById("chart3");
      const canvas4 = document.getElementById("chart4");

      async function loadCSV(path) {
        const response = await fetch(path);
        const text = await response.text();

        const rows = text.trim().split("\n");

        const headerRow = rows.shift();

        const titles = headerRow.replace(/"/g, "").split(",").slice(1);

        const labels = [];
        const data = [];

        rows.forEach((row) => {
          const [label, ...values] = row.replace(/"/g, "").split(",");
          labels.push(label);

          values.forEach((val, i) => {
            data[i] = [...(data[i] ?? []), Number(val)];
          });
        });

        return [labels, data, titles];
      }

      async function drawCharts() {
        const [labels1, data1, title1] = await loadCSV(
          "data/top10_most_prod_director.csv"
        );
        const [labels2, data2, title2] = await loadCSV(
          "data/rating_per_genre.csv"
        );
        const [labels3, data3, title3] = await loadCSV("data/movies_years.csv");

        try {
          const ctx1 = new Chart(canvas1, {
            type: "bar",
            data: {
              labels: labels1,
              datasets: [
                {
                  label: title1[0],
                  data: data1[0],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        } catch (error) {
          return;
        }

        try {
          const ctx2 = new Chart(canvas2, {
            type: "bar",
            data: {
              labels: labels2,
              datasets: [
                {
                  label: title2[0],
                  data: data2[0],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              aspectRatio: 0.8,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    display: true,
                    autoSkip: false,
                  },
                },
              },
            },
          });
        } catch (error) {
          return;
        }

        try {
          const ctx3 = new Chart(canvas3, {
            type: "bar",
            data: {
              labels: labels3,
              datasets: [
                {
                  label: title3[0],
                  data: data3[0],
                  borderWidth: 0,
                  backgroundColor: "#0099de",
                  borderColor: "#6fd2ff",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  min: 100,
                  beginAtZero: false,
                },
              },
              aspectRatio: 1,
            },
          });
        } catch (error) {
          return;
        }

        try {
          const ctx4 = new Chart(canvas4, cfg);
        } catch (error) {
          return;
        }
      }

      function checkChartsOnCanvases() {
        const canvasIds = ["chart1", "chart2", "chart3", "chart4"];
        canvasIds.forEach((id, index) => {
          const canvas = document.getElementById(id);
          const canvasDisplay = Chart.getChart(canvas);
          if (!canvasDisplay) {
            charts[index].hidden = true;
            infoButtons[index].hidden = true;
          }
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await drawCharts();
        checkChartsOnCanvases();
      });
    </script>
  </body>
</html>